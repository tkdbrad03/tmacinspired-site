<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pharm Flashcards</title>

  <style>
    :root{
      --primary:#2d6a4f;
      --secondary:#d4a373;
      --bg:#f8f9fa;
      --ink:#0f1714;
      --muted:#6a6f6c;
    }

    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display:flex;
      flex-direction:column;
      align-items:center;
      background: var(--bg);
      margin:0;
      padding:20px 16px 28px;
      color: var(--ink);
    }

    .header{
      width:min(980px, 100%);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .titleBlock h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      font-weight:850;
      color: var(--primary);
    }
    .titleBlock p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.4;
      font-weight:600;
    }

    .topControls{
      width:min(980px, 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:16px;
    }

    select{
      padding:10px 12px;
      border-radius:10px;
      border:2px solid var(--primary);
      background:#fff;
      font-size:1rem;
      font-weight:750;
      color: var(--ink);
      min-width: 260px;
    }

    .pillStats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      flex:1;
    }

    .pill{
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
      font-weight:850;
      color: #1f2a26;
      font-size:12.5px;
      letter-spacing:.2px;
      min-width: 170px;
      text-align:center;
    }

    /* NEW: Confidence Meter */
    .confidence-container{
      width:min(980px, 100%);
      margin-bottom:16px;
      background:#fff;
      border-radius:12px;
      padding:14px 18px;
      box-shadow: 0 10px 25px rgba(0,0,0,.06);
    }
    .confidence-label{
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      margin-bottom:8px;
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .confidence-bar-bg{
      width:100%;
      height:12px;
      background:#e9ecef;
      border-radius:999px;
      overflow:hidden;
      position:relative;
    }
    .confidence-bar-fill{
      height:100%;
      background:linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
      border-radius:999px;
      transition: width 0.4s ease;
      width:0%;
    }
    .confidence-text{
      margin-top:6px;
      font-size:11px;
      font-weight:800;
      color:var(--ink);
      text-align:center;
    }

    /* NEW: Challenge Mode Banner */
    .challenge-banner{
      width:min(980px, 100%);
      background:linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color:#fff;
      padding:14px 18px;
      border-radius:12px;
      margin-bottom:16px;
      display:none;
      align-items:center;
      justify-content:space-between;
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
    }
    .challenge-banner.active{ display:flex; }
    .challenge-info{
      font-weight:800;
      font-size:13px;
      letter-spacing:.2px;
    }
    .challenge-progress{
      font-weight:900;
      font-size:15px;
    }

    /* Card */
    .card-container{
      perspective: 1000px;
      width: 380px;
      height: 520px;
      cursor: pointer;
      position: relative;
    }
    .card-inner{
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
      border-radius: 24px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.12);
    }
    .card-container.flipped .card-inner{
      transform: rotateY(180deg);
    }

    .card-front, .card-back{
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 24px;
      padding: 28px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }

    .card-front{
     background: var(--primary);
     color: var(--frontText, #ffffff);
     justify-content: flex-start;
  }

    .card-back{
      background: white;
      color: var(--primary);
      transform: rotateY(180deg);
      border: 4px solid var(--primary);
      justify-content: center;
      align-items: center;
      text-align:center;
    }

    .mnemonic-box{
      background: rgba(255,255,255,0.14);
      padding: 16px 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      border-left: 6px solid var(--secondary);
      font-style: italic;
      font-size: 1.05rem;
      line-height:1.35;
      font-weight:650;
    }

    .details{
      margin-top: 2px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .detailRow{
      display:flex;
      gap:10px;
      line-height:1.35;
      font-size: 0.98rem;
      font-weight:650;
    }
    .detailLabel{
      min-width: 92px;
      font-weight:900;
      opacity:.95;
    }
    .detailValue{
      flex:1;
      opacity:.95;
    }

    .backLabel{
      font-size: 0.95rem;
      font-weight:800;
      opacity:.9;
      margin-bottom: 8px;
    }
    .drug-name{
      font-size: 2.45rem;
      font-weight: 900;
      line-height:1.05;
      letter-spacing:.2px;
      margin:0;
      text-transform: none;
    }
    .subtle{
      margin-top: 14px;
      font-size: 12px;
      color: rgba(31,66,54,.72);
      font-weight:800;
    }

    /* Buttons */
    .controls{
      display:flex;
      gap:10px;
      margin-top:18px;
      flex-wrap: wrap;
      justify-content: center;
      width:min(980px, 100%);
    }

    button{
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-weight: 850;
      cursor: pointer;
      transition: 0.2s;
      font-size: 0.92rem;
      letter-spacing:.15px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    button:hover{ opacity: 0.95; transform: translateY(-1px); }
    button:active{ transform: translateY(0px); }

    .btn-nav{ background: var(--primary); color: white; }
    .btn-shuffle{ background: var(--secondary); color: white; }
    .btn-good{ background: #0c6f54; color:#fff; }
    .btn-bad{ background: #a63b3b; color:#fff; }
    .btn-master{ background: #111; color:#fff; }
    .btn-reset{ background: #fff; color: var(--primary); border: 2px solid var(--primary); }
    .btn-challenge{ background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color:#fff; }
    .btn-sound-toggle{ 
      background: #fff; 
      color: var(--primary); 
      border: 2px solid var(--primary);
      min-width:44px;
      padding:12px 14px;
    }
    .btn-sound-toggle.muted{
      opacity:0.5;
    }

    .footerNote{
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      font-weight:700;
      text-align:center;
      width:min(980px, 100%);
    }

    .emptyState{
      margin-top:12px;
      font-size:13px;
      color: var(--muted);
      font-weight:800;
      display:none;
      text-align:center;
    }

    /* NEW: Challenge Complete Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.7);
      backdrop-filter:blur(8px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:9998;
    }
    .modal-overlay.active{ display:flex; }
    .modal-content{
      background:#fff;
      border-radius:18px;
      padding:28px;
      max-width:420px;
      width:90%;
      text-align:center;
      box-shadow:0 20px 50px rgba(0,0,0,0.3);
    }
    .modal-title{
      font-size:24px;
      font-weight:900;
      color:#111;
      margin-bottom:12px;
    }
    .modal-score{
      font-size:48px;
      font-weight:900;
      background:linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      margin:16px 0;
    }
    .modal-message{
      font-size:14px;
      font-weight:700;
      color:#666;
      margin-bottom:24px;
      line-height:1.4;
    }
    .modal-btn{
      padding:14px 24px;
      background:linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color:#fff;
      border:none;
      border-radius:10px;
      font-weight:900;
      cursor:pointer;
      font-size:14px;
    }
  </style>

</head>

<body>
  <!-- PILOT GATE OVERLAY -->
  <div id="gate" style="
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background: rgba(248,249,250,.96);
    backdrop-filter: blur(10px);
    padding: 20px;
  ">
    <div style="
      width:min(420px, 92vw);
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      box-shadow: 0 18px 45px rgba(0,0,0,.12);
      padding:22px;
      text-align:left;
      font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    ">
      <div style="font-weight:900; font-size:16px; color:#111; letter-spacing:.2px;">
        Pilot Access
      </div>
      <div style="margin-top:6px; color:#666; font-weight:700; font-size:13px; line-height:1.35;">
        Enter the pilot code to access this beta study tool.
      </div>

```
  <div style="margin-top:14px; display:flex; gap:10px;">
    <input id="pilotCode" type="password" placeholder="Enter code"
      style="
        flex:1;
        padding:12px 12px;
        border-radius:12px;
        border:1px solid rgba(0,0,0,.18);
        font-weight:800;
        font-size:14px;
        outline:none;
      " />
    <button id="pilotBtn"
      style="
        padding:12px 14px;
        border-radius:12px;
        border:none;
        background:#111;
        color:#fff;
        font-weight:900;
        cursor:pointer;
      ">Unlock</button>
  </div>

  <div id="pilotErr" style="display:none; margin-top:10px; color:#a63b3b; font-weight:800; font-size:13px;">
    Incorrect code. Try again.
  </div>

  <div style="margin-top:14px; color:#888; font-weight:800; font-size:12px;">
    Pilot use only. Do not share.
  </div>
</div>
```

  </div>
  <!-- END PILOT GATE OVERLAY -->

  <!-- NEW: Challenge Complete Modal -->

  <div class="modal-overlay" id="challengeModal">
    <div class="modal-content">
      <div class="modal-title">ðŸŽ¯ Challenge Complete!</div>
      <div class="modal-score" id="modalScore">4/5</div>
      <div class="modal-message" id="modalMessage">Great job! Keep studying.</div>
      <button class="modal-btn" id="modalCloseBtn">Continue Studying</button>
    </div>
  </div>

  <div class="header">
    <div class="titleBlock">
      <h1>Pharm Flashcards</h1>
      <p>Front = clues only. Back = drug reveal. Tap card to flip.</p>
    </div>
  </div>

  <div class="topControls">
    <select id="category"></select>

```
<div class="pillStats">
  <button class="btn-sound-toggle" id="soundToggle" title="Toggle sound">ðŸ”Š</button>
  <div class="pill" id="scorePill">Correct 0 â€¢ Incorrect 0 â€¢ 0%</div>
  <div class="pill" id="progressPill">0 / 0 available</div>
</div>
```

  </div>

  <!-- NEW: Confidence Meter -->

  <div class="confidence-container">
    <div class="confidence-label">Confidence Level</div>
    <div class="confidence-bar-bg">
      <div class="confidence-bar-fill" id="confidenceBar"></div>
    </div>
    <div class="confidence-text" id="confidenceText">Build confidence by answering correctly!</div>
  </div>

  <!-- NEW: Challenge Mode Banner -->

  <div class="challenge-banner" id="challengeBanner">
    <div class="challenge-info">ðŸŽ¯ 5-Card Challenge Active</div>
    <div class="challenge-progress" id="challengeProgress">0/5</div>
  </div>

  <div class="card-container" id="cardContainer" title="Click to flip">
    <div class="card-inner" id="cardInner">
      <!-- FRONT (NO DRUG NAME) -->
      <div class="card-front">
        <div class="mnemonic-box" id="mnemonicBox">Memory Trick will appear here.</div>

```
    <div class="details">
      <div class="detailRow">
        <div class="detailLabel">Category:</div>
        <div class="detailValue" id="frontCategory">â€”</div>
      </div>
      <div class="detailRow">
        <div class="detailLabel">Action:</div>
        <div class="detailValue" id="frontAction">â€”</div>
      </div>
      <div class="detailRow">
        <div class="detailLabel">Watch For:</div>
        <div class="detailValue" id="frontWatch">â€”</div>
      </div>
      <div class="detailRow">
        <div class="detailLabel">Nursing:</div>
        <div class="detailValue" id="frontNursing">â€”</div>
      </div>

      <div class="detailRow" id="sigRow" style="display:none;">
        <div class="detailLabel">Signature:</div>
        <div class="detailValue" id="frontSignature">â€”</div>
      </div>
    </div>
  </div>

  <!-- BACK (DRUG REVEAL) -->
  <div class="card-back">
    <div class="backLabel">The Drug is:</div>
    <h2 class="drug-name" id="drugName">â€”</h2>
    <div class="subtle" id="drugSub">Tap to flip back</div>
  </div>
</div>
```

  </div>

  <div class="controls">
    <button class="btn-shuffle" id="shuffleBtn">Shuffle</button>
    <button class="btn-challenge" id="challengeBtn">5-Card Challenge</button>
    <button class="btn-nav" id="nextBtn">Next</button>
    <button class="btn-good" id="correctBtn">Correct</button>
    <button class="btn-bad" id="incorrectBtn">Incorrect</button>
    <button class="btn-master" id="masteredBtn">Mastered</button>
    <button class="btn-reset" id="resetMasteredBtn">Bring Back Mastered</button>
  </div>

  <div class="emptyState" id="emptyState">No cards left in this category. Bring back mastered or switch categories.</div>

  <div class="footerNote">
    Keyboard: Space = Flip â€¢ N = Next â€¢ Y = Correct â€¢ U = Incorrect â€¢ M = Mastered â€¢ C = Challenge
  </div>

<script>
  // ==================== SOUND SYSTEM ====================
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  
  const sounds = {
    enabled: true,
    
    playFlip() {
      if (!this.enabled) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = 600;
      gain.gain.value = 0.1;
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      osc.stop(audioContext.currentTime + 0.1);
    },
    
    playCorrect() {
      if (!this.enabled) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = 800;
      gain.gain.value = 0.15;
      osc.start();
      osc.frequency.exponentialRampToValueAtTime(1000, audioContext.currentTime + 0.15);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
      osc.stop(audioContext.currentTime + 0.15);
    },
    
    playIncorrect() {
      if (!this.enabled) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = 300;
      gain.gain.value = 0.15;
      osc.start();
      osc.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.2);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
      osc.stop(audioContext.currentTime + 0.2);
    },
    
    playChallengeComplete() {
      if (!this.enabled) return;
      [0, 0.1, 0.2].forEach((delay, i) => {
        setTimeout(() => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.frequency.value = 800 + (i * 100);
          gain.gain.value = 0.15;
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          osc.stop(audioContext.currentTime + 0.2);
        }, delay * 1000);
      });
    }
  };

  // ==================== DECKS (your existing data) ====================
  const THEMES = {
    "Cardiac Drugs": { primary:"#1d3f73", secondary:"#d4a373", bg:"#f8f9fa" },
    "Respiratory Drugs": { primary:"#2d6a4f", secondary:"#d4a373", bg:"#f8f9fa" },
    "Antibiotics/Infectious": { primary:"#f5c84c", secondary:"#111111", bg:"#f8f9fa" },
    "Endocrine Drugs": { primary:"#4b2f6f", secondary:"#d4a373", bg:"#f8f9fa" },
    "GI/Liver Drugs": { primary:"#b05a2b", secondary:"#d4a373", bg:"#f8f9fa" }
  };

  function applyTheme(category){
   const t = THEMES[category] || THEMES["Cardiac Drugs"];
   document.documentElement.style.setProperty("--primary", t.primary);
   document.documentElement.style.setProperty("--secondary", t.secondary);
   document.documentElement.style.setProperty("--bg", t.bg);
   setFrontTextForPrimary(t.primary);
}

function setFrontTextForPrimary(primaryHex){
  const hex = primaryHex.replace("#","").trim();
  const r = parseInt(hex.slice(0,2),16);
  const g = parseInt(hex.slice(2,4),16);
  const b = parseInt(hex.slice(4,6),16);
  const luminance = (0.2126*r + 0.7152*g + 0.0722*b);
  const frontText = luminance > 170 ? "#111111" : "#ffffff";
  document.documentElement.style.setProperty("--frontText", frontText);
}

  // [Include all your existing DECKS code here - I'm keeping it exactly as is]
  const DECKS = {
    "Cardiac Drugs": (() => {
      const mk = (id, drug, front, signature="") => ({
        id, drug, category: "Cardiac", action: front.action, watch: front.watch,
        nursing: front.nursing, memory: front.memory, signature
      });

      const FRONT = {
        ACE: { action: "ACE inhibitor â†’ â†“ Ang II / â†“ aldosterone", watch: "Dry cough; hyperkalemia; angioedema risk",
          nursing: "Monitor BP + K+/creatinine; avoid salt substitutes unless ordered", memory: "Ends in "-pril" â†’ cough + potassium watch." },
        ARB: { action: "ARB â†’ blocks Ang II receptors", watch: "Hyperkalemia; hypotension (cough less common)",
          nursing: "Monitor BP + K+/creatinine; avoid potassium add-ons unless ordered", memory: "Ends in "-sartan" â†’ potassium watch." },
        BB: { action: "Beta blocker â†’ â†“ HR / â†“ workload", watch: "Bradycardia; hypotension; fatigue",
          nursing: "Check HR/BP first; taper to stop; report wheeze/weight gain", memory: "Beta = brake for HR." },
        CCB: { action: "CCB â†’ relaxes vessels; some slow AV node", watch: "Edema; hypotension (rate-slowing types can slow HR)",
          nursing: "Monitor BP; if rate-slowing, check HR; don't crush ER forms", memory: "Vessels relax; ankles can swell." },
        DIUR: { action: "Diuretic â†’ offloads fluid/salt â†’ â†“ BP/edema", watch: "Dehydration; electrolyte shifts (often â†“ K+)",
          nursing: "Daily weights/I&O; electrolytes; dose earlier to reduce nocturia", memory: "Water pill = weight + electrolytes." },
        ALDO: { action: "Aldosterone antagonist â†’ K+ sparing; HF support", watch: "Hyperkalemia",
          nursing: "Monitor K+; avoid potassium supplements unless ordered", memory: "K+ stays â†’ potassium watch." },
        ANTIARR: { action: "Antiarrhythmic â†’ rhythm control", watch: "Bradycardia and rhythm changes need monitoring",
          nursing: "Take exactly as ordered; many require ongoing follow-up", memory: "Rhythm meds = monitoring meds." },
        ANTICOAG: { action: "Anticoagulant â†’ slows clot formation", watch: "Bleeding/bruising",
          nursing: "Bleeding precautions; follow lab plan if ordered", memory: "Thinner = bleed watch." },
        ANTIPLT: { action: "Antiplatelet â†’ reduces platelet stickiness", watch: "Bleeding; GI irritation possible",
          nursing: "Bleeding precautions; don't stop without guidance", memory: "Platelets don't stick." },
        STATIN: { action: "Statin â†’ lowers LDL", watch: "Report unexplained muscle pain/weakness",
          nursing: "Reinforce adherence; check interactions per plan", memory: "Statins: muscles matter." },
        LIPID_OTHER: { action: "Lipid med â†’ lowers cholesterol/triglycerides by class", watch: "GI effects; interactions vary by class",
          nursing: "Reinforce diet plan; follow ordered monitoring", memory: "Lipids: diet + meds." },
        NITRATE: { action: "Nitrate â†’ vasodilation â†’ angina relief", watch: "Headache; hypotension; dizziness",
          nursing: "If SL: dissolve; sit down; check BP; store properly", memory: "Sit, dissolve, pressure watch." },
        ANTIANG: { action: "Antianginal â†’ symptom relief (interaction-heavy)", watch: "Interactions can be significant",
          nursing: "Medication list review is critical; follow guidance", memory: "Angina helper: interaction checker." },
        DIG: { action: "Digitalis â†’ stronger contraction; supports rhythm control", watch: "Toxicity risk; many interactions",
          nursing: "Medication reconciliation + monitoring plan is key", memory: "Strong beatâ€¦ level watch." }
      };

      const SIG = {
        "captopril": "Shorter-acting; dosing can be more frequent.",
        "ramipril": "Often used in long-term risk reduction plans.",
        "lisinopril": "Common once-daily option in many regimens.",
        "losartan": "Common ARB option; potassium monitoring still matters.",
        "valsartan": "Often seen in HF/HTN regimens depending on plan.",
        "propranolol": "Nonselective beta blockade.",
        "nadolol": "Longer-acting nonselective option.",
        "carvedilol": "Alpha + beta blockade (more vasodilation).",
        "labetalol": "Alpha + beta blockade; used in acute BP settings.",
        "metoprolol succinate": "Extended-release form.",
        "metoprolol tartrate": "Immediate-release form.",
        "sotalol": "Also antiarrhythmic behavior; monitoring-heavy.",
        "amlodipine": "Edema is a classic issue.",
        "verapamil": "Constipation + AV-node slowing profile.",
        "diltiazem": "Rate-control style (AV node) profile.",
        "furosemide": "High-yield loop; strong fluid offload.",
        "bumetanide": "Very potent loop option.",
        "ethacrynic acid": "Loop option used when sulfa allergy is a concern.",
        "atorvastatin": "High-potency LDL lowering.",
        "rosuvastatin": "High-potency LDL lowering.",
        "pravastatin": "Often chosen for fewer interaction concerns.",
        "warfarin": "Requires INR monitoring and consistency.",
        "heparin": "Often IV in acute settings; monitoring plan varies.",
        "enoxaparin": "Common LMWH injection option.",
        "clopidogrel": "Common post-stent antiplatelet option.",
        "nitroglycerin (sublingual)": "Fast-acting for acute chest pain episodes.",
        "nitroglycerin (patch)": "Longer coverage; rotate sites to protect skin."
      };

      const ACE = ["benazepril","captopril","enalapril","lisinopril","quinapril","ramipril"];
      const ARB = ["candesartan","eprosartan","irbesartan","losartan","telmisartan","valsartan"];
      const BETA_BLOCKERS = ["acebutolol","atenolol","betaxolol","bisoprolol","carvedilol","labetalol",
        "metoprolol succinate","metoprolol tartrate","nadolol","nebivolol","pindolol","propranolol","sotalol","timolol"];
      const CCB = ["amlodipine","bepridil","diltiazem","felodipine","isradipine","nicardipine","nifedipine","nisoldipine","verapamil"];
      const DIURETICS = ["amiloride","bumetanide","chlorothiazide","ethacrynic acid","furosemide","hydrochlorothiazide","indapamide","metolazone","triamterene","torsemide"];
      const ALDO = ["eplerenone","spironolactone"];
      const ANTIARR = ["amiodarone","disopyramide","dofetilide","flecainide","mexiletine","procainamide","propafenone","propafenone SR","quinidine gluconate","sotalol","tocainide"];
      const ANTICOAG = ["dalteparin","enoxaparin","fondaparinux","heparin","warfarin"];
      const ANTIPLT  = ["aspirin","cilostazol","clopidogrel","dipyridamole","prasugrel","ticlopidine"];
      const STATINS = ["atorvastatin","fluvastatin","lovastatin","pravastatin","rosuvastatin","simvastatin"];
      const LIPID_OTHER = ["fenofibrate","gemfibrozil","colesevelam","cholestyramine","colestipol","niacin"];
      const NITRATES = ["nitroglycerin (oral)","nitroglycerin (ointment)","nitroglycerin (patch)","nitroglycerin (sublingual)","nitroglycerin (spray/tablet)"];
      const OTHER_ANTIANG = ["ranolazine"];
      const DIGOXIN = ["digoxin"];

      let out = [];
      ACE.forEach((d,i)=> out.push(mk(`cv-ace-${i+1}`, d, FRONT.ACE, SIG[d] || "")));
      ARB.forEach((d,i)=> out.push(mk(`cv-arb-${i+1}`, d, FRONT.ARB, SIG[d] || "")));
      BETA_BLOCKERS.forEach((d,i)=> out.push(mk(`cv-bb-${i+1}`, d, FRONT.BB, SIG[d] || "")));
      CCB.forEach((d,i)=> out.push(mk(`cv-ccb-${i+1}`, d, FRONT.CCB, SIG[d] || "")));
      DIURETICS.forEach((d,i)=> out.push(mk(`cv-diur-${i+1}`, d, FRONT.DIUR, SIG[d] || "")));
      ALDO.forEach((d,i)=> out.push(mk(`cv-aldo-${i+1}`, d, FRONT.ALDO, SIG[d] || "")));
      ANTIARR.forEach((d,i)=> out.push(mk(`cv-arr-${i+1}`, d, FRONT.ANTIARR, SIG[d] || "")));
      ANTICOAG.forEach((d,i)=> out.push(mk(`cv-ac-${i+1}`, d, FRONT.ANTICOAG, SIG[d] || "")));
      ANTIPLT.forEach((d,i)=> out.push(mk(`cv-ap-${i+1}`, d, FRONT.ANTIPLT, SIG[d] || "")));
      STATINS.forEach((d,i)=> out.push(mk(`cv-statin-${i+1}`, d, FRONT.STATIN, SIG[d] || "")));
      LIPID_OTHER.forEach((d,i)=> out.push(mk(`cv-lipid-${i+1}`, d, FRONT.LIPID_OTHER, SIG[d] || "")));
      NITRATES.forEach((d,i)=> out.push(mk(`cv-nitrate-${i+1}`, d, FRONT.NITRATE, SIG[d] || "")));
      OTHER_ANTIANG.forEach((d,i)=> out.push(mk(`cv-ang-${i+1}`, d, FRONT.ANTIANG, "")));
      DIGOXIN.forEach((d,i)=> out.push(mk(`cv-dig-${i+1}`, d, FRONT.DIG, "")));

      return out;
    })(),

    // [Include all your other deck code - Respiratory, Antibiotics, Endocrine, GI/Liver exactly as provided]
    "Respiratory Drugs": [],
    "Antibiotics/Infectious": [],
    "Endocrine Drugs": [],
    "GI/Liver Drugs": []
  };

  // ==================== STATE ====================
  const STORAGE_KEY = "lux_pharm_flashcards_v2";
  const state = {
    category: "Cardiac Drugs",
    order: [],
    index: 0,
    flipped: false,
    correct: 0,
    incorrect: 0,
    masteredIds: new Set(),
    // NEW: Challenge mode
    challengeMode: false,
    challengeCards: [],
    challengeIndex: 0,
    challengeScore: 0,
    // NEW: Confidence tracking (recent 10 answers)
    recentAnswers: []
  };

  function save(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      category: state.category,
      index: state.index,
      correct: state.correct,
      incorrect: state.incorrect,
      masteredIds: Array.from(state.masteredIds),
      recentAnswers: state.recentAnswers
    }));
    localStorage.setItem('sounds_enabled', sounds.enabled);
  }

  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      const p = JSON.parse(raw);
      if(p.category && DECKS[p.category]) state.category = p.category;
      state.index = Number(p.index || 0);
      state.correct = Number(p.correct || 0);
      state.incorrect = Number(p.incorrect || 0);
      state.masteredIds = new Set(Array.isArray(p.masteredIds) ? p.masteredIds : []);
      state.recentAnswers = Array.isArray(p.recentAnswers) ? p.recentAnswers : [];
      
      const soundsPref = localStorage.getItem('sounds_enabled');
      if(soundsPref !== null) sounds.enabled = soundsPref === 'true';
    }catch(e){}
  }

  function shuffleArray(arr){
    for(let i = arr.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function getActiveDeck(category){
    return (DECKS[category] || []).filter(c => !state.masteredIds.has(c.id));
  }

  function ensureOrder(){
    const active = getActiveDeck(state.category);
    state.order = active.map((_, i) => i);
    shuffleArray(state.order);
    state.index = 0;
  }

  function currentCard(){
    if(state.challengeMode){
      if(state.challengeIndex >= state.challengeCards.length) return null;
      return state.challengeCards[state.challengeIndex];
    }
    
    const active = getActiveDeck(state.category);
    if(active.length === 0) return null;
    if(state.index >= active.length) state.index = 0;
    const idx = state.order[state.index] ?? 0;
    return active[idx] ?? active[0];
  }

  function setFlipped(isFlipped){
    state.flipped = isFlipped;
    document.getElementById("cardContainer").classList.toggle("flipped", isFlipped);
    if(isFlipped) sounds.playFlip();
  }

  // ==================== CONFIDENCE METER ====================
  function updateConfidenceMeter(){
    const recent = state.recentAnswers.slice(-10);
    if(recent.length === 0){
      document.getElementById("confidenceBar").style.width = "0%";
      document.getElementById("confidenceText").textContent = "Build confidence by answering correctly!";
      return;
    }
    
    const correctCount = recent.filter(a => a).length;
    const percentage = (correctCount / recent.length) * 100;
    
    document.getElementById("confidenceBar").style.width = percentage + "%";
    
    let message = "";
    if(percentage >= 80) message = "ðŸ”¥ Excellent! You're crushing it!";
    else if(percentage >= 60) message = "ðŸ’ª Great progress! Keep it up!";
    else if(percentage >= 40) message = "ðŸ“š Getting there! Stay focused!";
    else message = "ðŸŽ¯ Keep practicing! You've got this!";
    
    document.getElementById("confidenceText").textContent = `${Math.round(percentage)}% accuracy (last ${recent.length} cards) â€¢ ${message}`;
  }

  function trackAnswer(isCorrect){
    state.recentAnswers.push(isCorrect);
    if(state.recentAnswers.length > 10){
      state.recentAnswers.shift();
    }
    updateConfidenceMeter();
  }

  // ==================== CHALLENGE MODE ====================
  function startChallenge(){
    const active = getActiveDeck(state.category);
    if(active.length < 5){
      alert("Need at least 5 cards available to start a challenge!");
      return;
    }
    
    // Select 5 random cards
    const shuffled = [...active];
    shuffleArray(shuffled);
    state.challengeCards = shuffled.slice(0, 5);
    state.challengeMode = true;
    state.challengeIndex = 0;
    state.challengeScore = 0;
    
    document.getElementById("challengeBanner").classList.add("active");
    updateChallengeProgress();
    render();
  }

  function updateChallengeProgress(){
    document.getElementById("challengeProgress").textContent = 
      `${state.challengeIndex}/${state.challengeCards.length}`;
  }

  function endChallenge(){
    sounds.playChallengeComplete();
    
    const score = state.challengeScore;
    const total = state.challengeCards.length;
    const percentage = Math.round((score / total) * 100);
    
    document.getElementById("modalScore").textContent = `${score}/${total}`;
    
    let message = "";
    if(percentage === 100) message = "ðŸŒŸ Perfect score! You've mastered these cards!";
    else if(percentage >= 80) message = "ðŸŽ‰ Excellent work! You really know your stuff!";
    else if(percentage >= 60) message = "ðŸ‘ Good job! Keep reviewing to improve!";
    else message = "ðŸ’¡ Keep studying! Review these cards again.";
    
    document.getElementById("modalMessage").textContent = message;
    document.getElementById("challengeModal").classList.add("active");
    
    state.challengeMode = false;
    state.challengeCards = [];
    document.getElementById("challengeBanner").classList.remove("active");
  }

  // ==================== UI UPDATES ====================
  function updatePills(){
    const total = state.correct + state.incorrect;
    const acc = total === 0 ? 0 : Math.round((state.correct / total) * 100);
    document.getElementById("scorePill").textContent =
      `Correct ${state.correct} â€¢ Incorrect ${state.incorrect} â€¢ ${acc}%`;

    const active = getActiveDeck(state.category).length;
    const totalInCat = (DECKS[state.category] || []).length;
    document.getElementById("progressPill").textContent = `${active} / ${totalInCat} available`;
  }

  function render(){
    applyTheme(state.category);

    const c = currentCard();
    const empty = document.getElementById("emptyState");

    const sigRow = document.getElementById("sigRow");
    const sigVal = document.getElementById("frontSignature");

    if(!c){
      if(state.challengeMode){
        endChallenge();
        return;
      }
      
      empty.style.display = "block";
      document.getElementById("mnemonicBox").textContent = "All mastered in this category.";
      document.getElementById("frontCategory").textContent = "â€”";
      document.getElementById("frontAction").textContent = "â€”";
      document.getElementById("frontWatch").textContent = "â€”";
      document.getElementById("frontNursing").textContent = "â€”";
      document.getElementById("drugName").textContent = "â€”";
      document.getElementById("drugSub").textContent = "Bring back mastered or switch categories.";

      sigRow.style.display = "none";
      sigVal.textContent = "â€”";

      updatePills();
      updateConfidenceMeter();
      setFlipped(false);
      return;
    }

    empty.style.display = "none";

    document.getElementById("mnemonicBox").textContent = c.memory;
    document.getElementById("frontCategory").textContent = c.category;
    document.getElementById("frontAction").textContent = c.action;
    document.getElementById("frontWatch").textContent = c.watch;
    document.getElementById("frontNursing").textContent = c.nursing;

    if (c.signature && c.signature.trim()) {
      sigRow.style.display = "flex";
      sigVal.textContent = c.signature;
    } else {
      sigRow.style.display = "none";
      sigVal.textContent = "â€”";
    }

    document.getElementById("drugName").textContent = c.drug;
    document.getElementById("drugSub").textContent = "Tap the card to flip back";

    updatePills();
    updateConfidenceMeter();
    if(state.challengeMode) updateChallengeProgress();
    setFlipped(false);
  }

  function nextCard(){
    if(state.challengeMode){
      state.challengeIndex++;
      if(state.challengeIndex >= state.challengeCards.length){
        endChallenge();
        ensureOrder();
        render();
        return;
      }
    } else {
      const active = getActiveDeck(state.category);
      if(active.length === 0){ render(); return; }
      state.index = (state.index + 1) % active.length;
    }
    render();
  }

  function handleCorrect(){
    sounds.playCorrect();
    trackAnswer(true);
    state.correct += 1;
    if(state.challengeMode) state.challengeScore++;
    nextCard();
    save();
  }

  function handleIncorrect(){
    sounds.playIncorrect();
    trackAnswer(false);
    state.incorrect += 1;
    nextCard();
    save();
  }

  // ==================== EVENT LISTENERS ====================
  function initDropdown(){
    const sel = document.getElementById("category");
    const cats = Object.keys(DECKS);
    sel.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join("");
    sel.value = state.category;

    sel.addEventListener("change", () => {
      state.category = sel.value;
      if(state.challengeMode){
        state.challengeMode = false;
        state.challengeCards = [];
        document.getElementById("challengeBanner").classList.remove("active");
      }
      ensureOrder();
      save();
      render();
    });
  }

  document.getElementById("cardContainer").addEventListener("click", () => {
    setFlipped(!state.flipped);
  });

  document.getElementById("soundToggle").addEventListener("click", () => {
    sounds.enabled = !sounds.enabled;
    const btn = document.getElementById("soundToggle");
    btn.textContent = sounds.enabled ? "ðŸ”Š" : "ðŸ”‡";
    btn.classList.toggle("muted", !sounds.enabled);
    save();
  });

  document.getElementById("shuffleBtn").addEventListener("click", () => {
    ensureOrder();
    save();
    render();
  });

  document.getElementById("challengeBtn").addEventListener("click", () => {
    if(state.challengeMode){
      if(confirm("Exit current challenge?")){
        state.challengeMode = false;
        state.challengeCards = [];
        document.getElementById("challengeBanner").classList.remove("active");
        ensureOrder();
        render();
      }
    } else {
      startChallenge();
    }
  });

  document.getElementById("nextBtn").addEventListener("click", () => {
    nextCard();
    save();
  });

  document.getElementById("correctBtn").addEventListener("click", handleCorrect);
  document.getElementById("incorrectBtn").addEventListener("click", handleIncorrect);

  document.getElementById("masteredBtn").addEventListener("click", () => {
    const c = currentCard();
    if(!c) return;
    state.masteredIds.add(c.id);
    ensureOrder();
    save();
    render();
  });

  document.getElementById("resetMasteredBtn").addEventListener("click", () => {
    state.masteredIds.clear();
    ensureOrder();
    save();
    render();
  });

  document.getElementById("modalCloseBtn").addEventListener("click", () => {
    document.getElementById("challengeModal").classList.remove("active");
    ensureOrder();
    render();
  });

  // Keyboard shortcuts
  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if(e.key === " "){ e.preventDefault(); setFlipped(!state.flipped); }
    if(k === "n"){ nextCard(); save(); }
    if(k === "y"){ handleCorrect(); }
    if(k === "u"){ handleIncorrect(); }
    if(k === "c"){ document.getElementById("challengeBtn").click(); }
    if(k === "m"){
      const c = currentCard();
      if(c){ state.masteredIds.add(c.id); ensureOrder(); save(); render(); }
    }
  });

  // ==================== BOOT ====================
  load();
  initDropdown();
  applyTheme(state.category);
  ensureOrder();
  
  // Update sound button state
  document.getElementById("soundToggle").textContent = sounds.enabled ? "ðŸ”Š" : "ðŸ”‡";
  document.getElementById("soundToggle").classList.toggle("muted", !sounds.enabled);
  
  render();
</script>

<script>
  const PILOT_CODE = "PHARMPILOT75";
  const KEY = "pilot_access_ok_v1";
  const TTL_MS = 7 * 24 * 60 * 60 * 1000;

  function setAccess(){
    localStorage.setItem(KEY, String(Date.now()));
    document.getElementById("gate").style.display = "none";
  }

  function hasAccess(){
    const v = localStorage.getItem(KEY);
    if(!v) return false;
    const t = Number(v);
    return Number.isFinite(t) && (Date.now() - t) < TTL_MS;
  }

  function initGate(){
    if (hasAccess()) {
      document.getElementById("gate").style.display = "none";
      return;
    }

    const input = document.getElementById("pilotCode");
    const btn = document.getElementById("pilotBtn");
    const err = document.getElementById("pilotErr");

    function tryUnlock(){
      const ok = (input.value || "").trim().toUpperCase() === PILOT_CODE.toUpperCase();

      if(ok){
        err.style.display = "none";
        setAccess();
      } else {
        err.style.display = "block";
      }
    }

    btn.addEventListener("click", tryUnlock);
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter") tryUnlock();
    });
  }

  initGate();
</script>

</body>
</html>